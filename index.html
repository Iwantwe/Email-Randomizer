<script>
  let riwayat = new Set();
  let teksTerkunci = false;
  let teksInputan = "";
  let totalKemungkinan = 0;

  // Fungsi menyimpan data ke localStorage
  function simpanKeStorage() {
    localStorage.setItem("riwayat", JSON.stringify([...riwayat]));
    localStorage.setItem("teksInputan", teksInputan);
    localStorage.setItem("teksTerkunci", teksTerkunci);
    localStorage.setItem("totalKemungkinan", totalKemungkinan);
  }

  // Fungsi memuat data dari localStorage saat halaman dibuka
  function muatDariStorage() {
    const simpanRiwayat = JSON.parse(localStorage.getItem("riwayat") || "[]");
    riwayat = new Set(simpanRiwayat);
    teksInputan = localStorage.getItem("teksInputan") || "";
    teksTerkunci = localStorage.getItem("teksTerkunci") === "true";
    totalKemungkinan = parseInt(localStorage.getItem("totalKemungkinan")) || 0;

    if (teksTerkunci) {
      document.getElementById("inputText").value = teksInputan;
      document.getElementById("inputText").disabled = true;
      updateSisa();
    }
  }

  // Jalankan saat halaman selesai dimuat
  window.addEventListener("DOMContentLoaded", () => {
    muatDariStorage();
  });

  function kunciTeks() {
    const inputElem = document.getElementById("inputText");
    const pesan = document.getElementById("pesan");
    const input = inputElem.value;

    if (!input) {
      pesan.textContent = "Teks tidak boleh kosong.";
      return;
    }

    teksInputan = input;
    teksTerkunci = true;
    inputElem.disabled = true;
    pesan.textContent = "Teks dikunci. Silakan mulai mengacak.";
    totalKemungkinan = Math.pow(2, (input.match(/[a-zA-Z]/g) || []).length);
    updateSisa();
    simpanKeStorage(); // simpan setelah kunci
  }

  function acakBesarKecil() {
    const output = document.getElementById("outputText");
    const pesan = document.getElementById("pesan");

    if (!teksTerkunci || !teksInputan) {
      pesan.textContent = "Masukkan dan kunci teks terlebih dahulu.";
      return;
    }

    if (riwayat.size >= totalKemungkinan) {
      pesan.textContent = "Semua kombinasi huruf besar/kecil telah digunakan!";
      return;
    }

    let hasilUnik = "";
    let percobaan = 0;
    do {
      hasilUnik = "";
      for (let i = 0; i < teksInputan.length; i++) {
        const huruf = teksInputan[i];
        hasilUnik += /[a-zA-Z]/.test(huruf)
          ? (Math.random() < 0.5 ? huruf.toLowerCase() : huruf.toUpperCase())
          : huruf;
      }
      percobaan++;
      if (percobaan > 1000) {
        pesan.textContent = "Gagal menemukan kombinasi unik.";
        return;
      }
    } while (riwayat.has(hasilUnik));

    riwayat.add(hasilUnik);
    output.textContent = hasilUnik;
    pesan.textContent = "";
    updateSisa();
    simpanKeStorage(); // simpan setiap kali kombinasi ditambahkan
  }

  function salinTeks() {
    const teks = document.getElementById("outputText").textContent;
    if (!teks) return;
    navigator.clipboard.writeText(teks).then(() => {
      alert("Teks berhasil disalin ke clipboard!");
    }).catch(err => {
      alert("Gagal menyalin: " + err);
    });
  }

  function resetTeks() {
    const inputElem = document.getElementById("inputText");
    teksInputan = "";
    teksTerkunci = false;
    riwayat.clear();
    totalKemungkinan = 0;
    inputElem.disabled = false;
    inputElem.value = "";
    document.getElementById("outputText").textContent = "";
    document.getElementById("pesan").textContent = "Teks berhasil direset.";
    document.getElementById("sisaKemungkinan").textContent = "";

    // Hapus dari localStorage juga
    localStorage.removeItem("riwayat");
    localStorage.removeItem("teksInputan");
    localStorage.removeItem("teksTerkunci");
    localStorage.removeItem("totalKemungkinan");
  }

  function updateSisa() {
    const sisa = totalKemungkinan - riwayat.size;
    document.getElementById("sisaKemungkinan").textContent =
      `Sisa kombinasi unik: ${sisa} dari total ${totalKemungkinan}`;
  }
</script>
